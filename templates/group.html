{{ define "content" }}
<section class="section">
    <div class="container">
        <!-- Header Section -->
        <div class="columns is-centered">
            <div class="column is-10">
                <div class="has-text-centered mb-6">
                    <h1 class="title is-2">{{ .GroupName }}</h1>
                    <h2 class="subtitle is-5 has-text-grey">{{ .GroupDescription }}</h2>
                    <a href="/dashboard" class="button is-light">
                        <span class="icon">
                            <i class="fas fa-arrow-left"></i>
                        </span>
                        <span>Back to Groups</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        {{ if eq $.User.ID .GroupCreatorId }}
        <div class="columns is-centered">
            <div class="column is-10">
                <div class="has-text-centered mb-4">
                    <button class="button is-info mr-3 mb-3" onclick="openMembersModal()">
                        <span class="icon">
                            <i class="fas fa-user-plus"></i>
                        </span>
                        <span>Add Members</span>
                    </button>
                </div>
            </div>
        </div>
        {{ end }}

        <!-- Members Modal -->
        <div id="members-modal" class="modal">
            <div class="modal-background" onclick="closeMembersModal()"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add new members to your group</p>
                    <button class="delete" aria-label="close" onclick="closeMembersModal()"></button>
                </header>
                <section class="modal-card-body">
                    <div class="field">
                        <label class="label">Search Users</label>
                        <div class="control">
                            <input class="input" type="text" name="usernameSearchTerm"
                                placeholder="Type username to search..."
                                hx-post="/users/search/exclude-group/{{ .GroupId }}"
                                hx-trigger="input changed delay:300ms" hx-target="#user-search-results"
                                hx-indicator="#search-indicator">
                        </div>
                        <div class="mt-2">
                            <span id="search-indicator" class="htmx-indicator">
                                <span class="icon">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                                Searching...
                            </span>
                        </div>
                    </div>
                    <div id="user-search-results" class="mt-4">
                        <!-- Search results will appear here -->
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button class="button" onclick="closeMembersModal()">Close</button>
                </footer>
            </div>
        </div>

        <!-- Gift Modal -->
        <div id="gift-modal" class="modal">
            <div class="modal-background" onclick="closeGiftModal()"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Add a gift to your Wishlist</p>
                    <button class="delete" aria-label="close" onclick="closeGiftModal()"></button>
                </header>
                <section class="modal-card-body">
                    <form id="gift-form" method="POST" action="/groups/{{ .GroupId }}/gifts">
                        <div class="field">
                            <label class="label">Gift Title</label>
                            <div class="control">
                                <input class="input" type="text" name="title" placeholder="Enter gift title" required>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Description</label>
                            <div class="control">
                                <textarea class="textarea" name="description" placeholder="Describe the gift"
                                    rows="3"></textarea>
                            </div>
                        </div>

                        <div class="field">
                            <label class="label">Link (optional)</label>
                            <div class="control">
                                <input class="input" type="url" name="link" placeholder="https://example.com/product">
                            </div>
                        </div>
                    </form>
                </section>
                <footer class="modal-card-foot">
                    <button class="button is-primary" onclick="submitGiftForm()">
                        <span class="icon">
                            <i class="fas fa-gift"></i>
                        </span>
                        <span>Add to Wishlist</span>
                    </button>
                    <button class="button ml-3" onclick="closeGiftModal()">Cancel</button>
                </footer>
            </div>
        </div>

        <!-- Gifts Display Modal -->
        <div id="gifts-modal" class="modal">
            <div class="modal-background" onclick="closeGiftsModal()"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <div style="width: 100%;">
                        <p class="modal-card-title" id="gifts-modal-title">Gifts</p>
                        <div id="add-gift-btn-header" style="display: none; margin-top: 0.5rem;">
                            <button class="button is-primary is-small">
                                <span class="icon is-small">
                                    <i class="fas fa-gift"></i>
                                </span>
                                <span>Add a gift</span>
                            </button>
                        </div>
                    </div>
                    <button class="delete" aria-label="close" onclick="closeGiftsModal()"></button>
                </header>
                <section class="modal-card-body">
                    <div id="gifts-modal-content">
                        <!-- Gifts will be loaded here -->
                    </div>
                </section>
                <footer class="modal-card-foot">
                    <button class="button" onclick="closeGiftsModal()">Close</button>
                </footer>
            </div>
        </div>

        <!-- Members Section -->
        <div class="columns is-centered">
            <div class="column is-10">
                <h2 class="title is-4 mb-4">Members</h2>
                <div class="columns is-multiline">
                    {{ range .Members }}
                    <div class="column is-half-desktop is-half-tablet">
                        <div class="card is-clickable"
                            onclick="openGiftsModal('{{ .MemberUsername }}', '{{ .GroupId }}', '{{ .MemberId }}')">
                            <div class="card-content">
                                <div class="media">
                                    <div class="media-left">
                                        <figure class="image is-48x48">
                                            <span class="icon is-large has-text-primary">
                                                <i class="fa fa-user-circle fa-2x"></i>
                                            </span>
                                        </figure>
                                    </div>
                                    <div class="media-content">
                                        <p class="title is-5 mb-1">
                                            {{ .MemberUsername }}
                                            {{ if eq .MemberId $.GroupCreatorId }}
                                            <span class="tag is-warning is-light">
                                                <span class="icon">
                                                    <i class="fas fa-crown"></i>
                                                </span>
                                                <span>Owner</span>
                                            </span>
                                            {{ end }}
                                            {{ if eq .MemberId $.User.ID }}
                                            <span class="tag is-primary is-small ml-2">You</span>
                                            {{ end }}
                                        </p>
                                        <p class="subtitle is-6 has-text-grey">
                                            <span class="icon is-small">
                                                <i class="fas fa-gift"></i>
                                            </span>
                                            {{ if eq .MemberId $.User.ID }}
                                            View and edit your wishlist
                                            {{ else }}
                                            View wishlist
                                            {{ end }}
                                        </p>
                                    </div>
                                    <div class="media-right">
                                        <span class="icon has-text-grey-light">
                                            <i class="fas fa-chevron-right"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    function openGiftModal() {
        document.getElementById('gift-modal').classList.add('is-active');
    }

    function openGiftModalFromGifts() {
        // Close the gifts modal first
        closeGiftsModal();
        // Then open the gift form modal
        openGiftModal();
    }

    function closeGiftModal() {
        document.getElementById('gift-modal').classList.remove('is-active');
        // Reset form
        document.getElementById('gift-form').reset();
    }

    function submitGiftForm() {
        document.getElementById('gift-form').submit();
    }

    function openMembersModal() {
        document.getElementById('members-modal').classList.add('is-active');
    }

    function closeMembersModal() {
        document.getElementById('members-modal').classList.remove('is-active');
        // Clear search results and input
        document.querySelector('input[name="usernameSearchTerm"]').value = '';
        document.getElementById('user-search-results').innerHTML = '';
    }

    function openGiftsModal(username, groupId, memberId) {
        // Set the modal title
        document.getElementById('gifts-modal-title').textContent = username + "'s Wishlist";

        // Clear previous content
        document.getElementById('gifts-modal-content').innerHTML = '<div class="has-text-centered"><span class="icon"><i class="fas fa-spinner fa-spin"></i></span> Loading gifts...</div>';

        // Show/hide the "Add a gift" button based on whether this is the current user's modal
        const addGiftBtnContainer = document.getElementById('add-gift-btn-header');
        const addGiftBtn = addGiftBtnContainer.querySelector('button');
        const currentUserId = '{{ $.User.ID }}';
        if (memberId === currentUserId) {
            addGiftBtnContainer.style.display = 'block';
            // Set the click handler
            addGiftBtn.onclick = openGiftModalFromGifts;
        } else {
            addGiftBtnContainer.style.display = 'none';
        }

        // Open the modal
        document.getElementById('gifts-modal').classList.add('is-active');

        // Load gifts using HTMX
        htmx.ajax('GET', `/groups/${groupId}/user/${memberId}/gifts`, {
            target: '#gifts-modal-content',
            swap: 'innerHTML'
        });
    }

    function closeGiftsModal() {
        document.getElementById('gifts-modal').classList.remove('is-active');
        // Clear content
        document.getElementById('gifts-modal-content').innerHTML = '';
    }

    // Close modals on Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeGiftModal();
            closeMembersModal();
            closeGiftsModal();
        }
    });
</script>
{{ end }}